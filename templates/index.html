<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Tickets 2026</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;}
        .container{max-width:1000px;margin:0 auto;}
        header{text-align:center;color:white;margin-bottom:40px;}
        header h1{font-size:2.5rem;margin-bottom:10px;}
        .section{background:white;margin:20px 0;padding:30px;border-radius:15px;box-shadow:0 15px 35px rgba(0,0,0,0.1);}
        .events-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px;}
        .event-card{background:#f8f9ff;padding:20px;border-radius:12px;border-left:4px solid #667eea;cursor:pointer;transition:all 0.3s;}
        .event-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,0.15);}
        .form-group{margin-bottom:20px;}
        .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#333;}
        .form-group input,.form-group select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:8px;font-size:16px;}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:#667eea;}
        .button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px 30px;border:none;border-radius:8px;font-size:16px;cursor:pointer;width:100%;}
        .button:hover{transform:translateY(-2px);}
        .success{background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin-top:20px;display:none;align-items:center;gap:10px;}
        .error{background:#f8d7da;color:#721c24;padding:15px;border-radius:8px;margin-top:20px;}
        @media (max-width:768px){header h1{font-size:2rem;}.container{padding:10px;}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-ticket-alt"></i> Event Tickets 2026</h1>
            <p>Book your tickets for amazing events!</p>
        </header>
        
        <div class="section">
            <h2 style="margin-bottom:20px;color:#333;"><i class="fas fa-calendar"></i> Upcoming Events</h2>
            <div id="events-list" class="events-grid" style="min-height:100px;">
                <div style="text-align:center;padding:40px;color:#666;">Loading events...</div>
            </div>
        </div>
        
        <div class="section">
            <h2 style="margin-bottom:20px;color:#333;"><i class="fas fa-shopping-cart"></i> Book Tickets</h2>
            <form id="ticket-form">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Select Event</label>
                    <select id="event-select" name="eventId" required>
                        <option value="">Loading events...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tickets-alt"></i> Tickets</label>
                    <input type="number" name="tickets" min="1" max="10" value="1" required>
                </div>
                <button type="submit" class="button"><i class="fas fa-credit-card"></i> Book Now</button>
            </form>
            <div id="success-message" class="success">
                <i class="fas fa-check-circle"></i> Booking confirmed! üé´ Check your Supabase dashboard.
            </div>
            <div id="error-message" class="error" style="display:none;">
                <i class="fas fa-exclamation-triangle"></i> Error: <span id="error-text"></span>
            </div>
        </div>
    </div>

    <script>
        console.log("üî• Page loaded - testing API...");
        
        async function loadEvents() {
            const eventsList = document.getElementById('events-list');
            const eventSelect = document.getElementById('event-select');
            const errorMsg = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            try {
                console.log("üåê Fetching /api/events...");
                const response = await fetch('/api/events');
                console.log("üì° Response status:", response.status);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const events = await response.json();
                console.log("‚úÖ Events received:", events);
                
                if (!events || events.length === 0) {
                    throw new Error("No events found");
                }
                
                // Clear loading
                eventsList.innerHTML = '';
                eventSelect.innerHTML = '<option value="">Select an event...</option>';
                
                // Populate events
                events.forEach(event => {
                    // Event cards
                    const card = document.createElement('div');
                    card.className = 'event-card';
                    card.innerHTML = `
                        <h3>${event.name || 'Unknown'}</h3>
                        <div><i class="fas fa-calendar"></i> ${event.date || 'TBD'}</div>
                        <div><i class="fas fa-users"></i> ${event.available || 0} tickets available</div>
                    `;
                    eventsList.appendChild(card);
                    
                    // Dropdown options
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.name} - ${event.date}`;
                    eventSelect.appendChild(option);
                });
                
                console.log("üéâ Events loaded successfully!");
                
            } catch (error) {
                console.error("‚ùå Error:", error);
                eventsList.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">Error loading events. Using fallback data.</div>';
                eventSelect.innerHTML = '<option value="1">Tech Conference 2026 - March 15 (47 tickets)</option><option value="2">Music Festival - April 22 (23 tickets)</option><option value="3">Startup Pitch Night - May 10 (89 tickets)</option>';
                errorMsg.style.display = 'block';
                errorText.textContent = error.message;
            }
        }
        
        // Form submission
        document.getElementById('ticket-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');
            
            try {
                const response = await fetch('/book', { method: 'POST', body: formData });
                const result = await response.json();
                
                if (result.success) {
                    successMsg.style.display = 'flex';
                    this.reset();
                    this.querySelector('input[name="tickets"]').value = '1';
                    errorMsg.style.display = 'none';
                    setTimeout(() => successMsg.style.display = 'none', 5000);
                }
            } catch (error) {
                console.error('Booking error:', error);
            }
        });
        
        // Load on page ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadEvents);
        } else {
            loadEvents();
        }
    </script>
</body>
</html>
